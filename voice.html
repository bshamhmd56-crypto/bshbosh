<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>قارئ النصوص بالصوت</title>
</head>
<body>
  <h2>قارئ النصوص بالصوت</h2>
  
  <textarea id="text" rows="10" cols="60" placeholder="أدخل النص هنا..."></textarea><br>
  <input type="file" id="fileInput"><br><br>

  <label>اختيار الصوت:</label>
  <select id="voiceSelect"></select><br><br>

  <label>اختيار التنسيق:</label>
  <select id="formatSelect">
    <option value="mp3">MP3</option>
    <option value="wav">WAV</option>
    <option value="ogg">OGG</option>
  </select><br><br>

  <button onclick="speakText()">قراءة النص</button>
  <button onclick="speakFile()">قراءة الملف</button>
  <button onclick="stopSpeech()">إيقاف الصوت</button>
  <button onclick="clearText()">حذف النص</button>
  <button onclick="downloadAudio()">تنزيل الصوت</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptx-parser/dist/pptx-parser.min.js"></script>

  <script>
    let audioChunks = [];
    let mediaRecorder;
    let selectedVoice = null;

    // تحميل الأصوات
    function loadVoices() {
      const voices = window.speechSynthesis.getVoices();
      const select = document.getElementById("voiceSelect");
      select.innerHTML = "";

      voices.forEach((voice, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = voice.name + " (" + voice.lang + ")";
        select.appendChild(option);
      });

      const arabicVoiceIndex = voices.findIndex(v => v.lang.startsWith("ar"));
      if (arabicVoiceIndex >= 0) {
        select.value = arabicVoiceIndex;
        selectedVoice = voices[arabicVoiceIndex];
      }
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    document.getElementById("voiceSelect").addEventListener("change", e => {
      const voices = window.speechSynthesis.getVoices();
      selectedVoice = voices[e.target.value];
    });

    // تقسيم النصوص الطويلة
    function splitText(text, chunkSize = 3000) {
      const chunks = [];
      for (let i = 0; i < text.length; i += chunkSize) {
        chunks.push(text.substring(i, i + chunkSize));
      }
      return chunks;
    }

    // قراءة نص طويل
    function speakLongText(text) {
      audioChunks = [];
      const chunks = splitText(text);
      let index = 0;

      const audioContext = new AudioContext();
      const dest = audioContext.createMediaStreamDestination();
      mediaRecorder = new MediaRecorder(dest.stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();

      function speakChunk() {
        if (index < chunks.length) {
          const utterance = new SpeechSynthesisUtterance(chunks[index]);
          utterance.voice = selectedVoice;
          utterance.lang = selectedVoice ? selectedVoice.lang : "ar-SA";
          utterance.rate = 1;
          utterance.pitch = 1;
          utterance.onend = () => {
            index++;
            setTimeout(speakChunk, 300);
          };
          window.speechSynthesis.speak(utterance);
        } else {
          mediaRecorder.stop();
        }
      }
      speakChunk();
    }

    function speakText() {
      const text = document.getElementById("text").value;
      speakLongText(text);
    }

    function speakFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        alert("الرجاء اختيار ملف أولاً!");
        return;
      }

      const reader = new FileReader();
      const ext = file.name.split('.').pop().toLowerCase();

      if (ext === "txt") {
        reader.onload = e => speakLongText(e.target.result);
        reader.readAsText(file, "UTF-8");
      } else if (ext === "docx") {
        reader.onload = e => {
          mammoth.extractRawText({ arrayBuffer: e.target.result })
            .then(result => speakLongText(result.value));
        };
        reader.readAsArrayBuffer(file);
      } else if (ext === "pdf") {
        reader.onload = async e => {
          const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
          let text = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str).join(" ") + " ";
          }
          speakLongText(text);
        };
        reader.readAsArrayBuffer(file);
      } else if (ext === "pptx") {
        reader.onload = async e => {
          const slides = await window.pptxParser.parse(e.target.result);
          let text = slides.map(slide => slide.text).join(" ");
          speakLongText(text);
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert("صيغة الملف غير مدعومة!");
      }
    }

    function stopSpeech() {
      window.speechSynthesis.cancel();
    }

    function clearText() {
      document.getElementById("text").value = "";
    }

    function downloadAudio() {
      if (audioChunks.length > 0) {
        const format = document.getElementById("formatSelect").value;
        let mimeType;
        if (format === "wav") mimeType = "audio/wav";
        else if (format === "ogg") mimeType = "audio/ogg";
        else mimeType = "audio/mp3";

        const blob = new Blob(audioChunks, { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `speech.${format}`;
        a.click();
      } else {
        alert("لم يتم تسجيل أي صوت بعد!");
      }
    }
  </script>
</body>
</html>
